# Web Từ Thiện – Spring Boot + Microservices

Project skeleton generated by assistant. Stack:
- Java 17, Spring Boot
- Maven
- MySQL (Docker)
- Microservices Architecture
- Docker & Kubernetes

## Quick Start - Chạy App trong 3 bước

### Bước 1: Cài đặt Docker Desktop
1. Download Docker Desktop: https://www.docker.com/products/docker-desktop
2. Cài đặt và khởi động Docker Desktop
3. Đợi Docker Desktop hiển thị trạng thái "running" (màu xanh)

### Bước 2: Clone và Navigate vào Project
```powershell
# Nếu chưa clone
git clone <repository-url>
cd web_tu_thien

# Hoặc nếu đã có project
cd c:\Users\capij\work\git\web_tu_thien
```

### Bước 3: Chạy Docker Compose
```powershell
# Chạy tất cả services (MySQL, Web App, REST API)
docker-compose up --build
```

⏱️ **Lưu ý về thời gian build:**
- **Lần đầu**: 5-10 phút (download Java, Maven, dependencies)
- **Lần sau**: 1-2 phút (chỉ build code thay đổi)
- Docker sẽ cache các layers, nên lần build sau rất nhanh

### ✅ Xong! Truy cập App:
- **Web App**: http://localhost:8080
- **REST API**: http://localhost:8081
- **MySQL**: localhost:3307

### Dừng App:
```powershell
# Nhấn Ctrl+C trong terminal
# Hoặc chạy lệnh:
docker-compose down
```

---

## Docker Compose (Khuyến nghị cho Development)

### Yêu cầu
- Docker Desktop (https://www.docker.com/products/docker-desktop)
- Docker Compose (đã tích hợp trong Docker Desktop)

### Cài đặt và chạy

```powershell
# Build và start tất cả services (MySQL + Web App + REST API)
docker-compose up --build

# Chạy ở chế độ background
docker-compose up -d

# Xem logs
docker-compose logs -f

# Stop tất cả services
docker-compose down

# Stop và xóa volumes (dữ liệu MySQL)
docker-compose down -v
```

### Services
- **MySQL**: `localhost:3307` (container tự động khởi động)
- **Web App**: `http://localhost:8080`
- **REST API**: `http://localhost:8081`

### Credentials
- MySQL User: `app_user`
- MySQL Password: `app_password`
- MySQL Database: `web_tu_thien`

### Lưu ý
- Data được lưu trong Docker volume `mysql_data`
- Không mất data khi restart container
- Chỉ mất data khi chạy `docker-compose down -v`

### Tối ưu hóa Build Speed

**1. Build riêng từng service (nhanh hơn build tất cả):**
```powershell
# Chỉ build webapp
docker-compose build webapp

# Chỉ build restapi
docker-compose build restapi

# Start tất cả (không rebuild)
docker-compose up
```

**2. Sử dụng cache hiệu quả:**
```powershell
# Lần đầu (lâu 5-10 phút)
docker-compose build

# Lần sau (nhanh 1-2 phút - chỉ build code thay đổi)
docker-compose build
```

**3. Build nhanh khi development:**
```powershell
# Start mà không rebuild (nếu code không đổi)
docker-compose up

# Rebuild chỉ khi code thay đổi
docker-compose up --build
```

**4. Xem progress khi build:**
```powershell
# Hiển thị chi tiết quá trình build
docker-compose build --progress=plain
```

### Thời gian Build Dự kiến

| Lần build | Thời gian | Lý do |
|-----------|-----------|-------|
| **Lần 1** | 5-10 phút | Download Java image (200MB), Maven dependencies (100MB+) |
| **Lần 2** | 1-2 phút | Chỉ compile code, cache được sử dụng |
| **Code thay đổi nhỏ** | 30-60 giây | Maven incremental build |
| **Không thay đổi** | 5-10 giây | Chỉ start container |

### Làm gì trong khi chờ build lần đầu?

```powershell
# Mở terminal mới và xem progress
docker-compose logs -f

# Hoặc check Docker Desktop Dashboard
# Docker Desktop > Containers > web-tu-thien
```

### Troubleshooting Docker Compose

**Lỗi "release version 21 not supported":**
```powershell
# Nguyên nhân: Java version không khớp giữa pom.xml và Dockerfile
# Giải pháp 1: Sửa pom.xml về Java 17
# <java.version>17</java.version>

# Giải pháp 2: Nâng Dockerfile lên Java 21
# FROM maven:3.9-eclipse-temurin-21-alpine AS build
# FROM eclipse-temurin:21-jre-alpine

# Sau đó rebuild
docker-compose build --no-cache
docker-compose up
```

**Build quá lâu (>15 phút):**
```powershell
# 1. Kiểm tra kết nối internet (download dependencies)
# 2. Clear cache và rebuild
docker builder prune -a
docker-compose build --no-cache

# 3. Tăng RAM cho Docker Desktop
# Docker Desktop > Settings > Resources > Memory: 4GB+
```

**Lỗi "port already allocated":**
```powershell
# Kiểm tra port đang dùng
netstat -ano | findstr :8080
netstat -ano | findstr :3307

# Kill process (thay PID bằng số hiển thị)
taskkill /PID <PID> /F
```

**Rebuild lại image sau khi sửa code:**
```powershell
docker-compose up --build
```

**Xóa tất cả và start lại từ đầu:**
```powershell
docker-compose down -v
docker-compose up --build
```

## Kubernetes (Production & Scaling)

### Quick Start Kubernetes

#### Bước 1: Cài đặt Tools
```powershell
# Cài Chocolatey
Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

# Cài Minikube và kubectl
choco install minikube kubectl
```

#### Bước 2: Start Minikube
```powershell
minikube start --driver=docker
```

#### Bước 3: Build Images
```powershell
# Point Docker to Minikube
& minikube -p minikube docker-env --shell powershell | Invoke-Expression

# Build
docker build -t web-tu-thien-webapp:latest -f Dockerfile.webapp .
docker build -t web-tu-thien-restapi:latest -f Dockerfile.restapi .
```

#### Bước 4: Deploy
```powershell
kubectl apply -f k8s/mysql-deployment.yaml
kubectl apply -f k8s/webapp-deployment.yaml
kubectl apply -f k8s/restapi-deployment.yaml
```

#### Bước 5: Access Services
```powershell
minikube service webapp
minikube service restapi
```

### Yêu cầu
- Minikube hoặc Docker Desktop with Kubernetes
- kubectl CLI

### Cài đặt Minikube (Windows)

```powershell
# Cài Chocolatey (nếu chưa có)
Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

# Cài Minikube
choco install minikube

# Cài kubectl
choco install kubernetes-cli

# Start Minikube
minikube start --driver=docker
```

### Build Docker Images cho Kubernetes

```powershell
# Set Docker environment to Minikube
& minikube -p minikube docker-env --shell powershell | Invoke-Expression

# Build images
docker build -t web-tu-thien-webapp:latest -f Dockerfile.webapp .
docker build -t web-tu-thien-restapi:latest -f Dockerfile.restapi .
```

### Deploy lên Kubernetes

```powershell
# Apply tất cả manifests
kubectl apply -f k8s/mysql-deployment.yaml
kubectl apply -f k8s/webapp-deployment.yaml
kubectl apply -f k8s/restapi-deployment.yaml

# Kiểm tra deployments
kubectl get deployments
kubectl get pods
kubectl get services

# Xem logs
kubectl logs -f deployment/webapp
kubectl logs -f deployment/restapi

# Access services
minikube service webapp
minikube service restapi
```

### Scaling

```powershell
# Scale webapp
kubectl scale deployment webapp --replicas=3

# Scale restapi
kubectl scale deployment restapi --replicas=3

# Xem status
kubectl get pods -w
```

### Update và Rolling Update

```powershell
# Rebuild image (sau khi code thay đổi)
docker build -t web-tu-thien-webapp:latest -f Dockerfile.webapp .

# Rolling update
kubectl rollout restart deployment/webapp

# Kiểm tra rollout status
kubectl rollout status deployment/webapp

# Rollback nếu cần
kubectl rollout undo deployment/webapp
```

### Monitoring

```powershell
# Dashboard
minikube dashboard

# Resource usage
kubectl top nodes
kubectl top pods

# Describe resources
kubectl describe deployment webapp
kubectl describe service webapp
```

### Clean up

```powershell
# Xóa tất cả resources
kubectl delete -f k8s/

# Hoặc xóa từng loại
kubectl delete deployment webapp restapi mysql
kubectl delete service webapp restapi mysql
kubectl delete pvc mysql-pvc
kubectl delete secret mysql-secret

# Stop Minikube
minikube stop

# Delete cluster
minikube delete
```

### Troubleshooting Kubernetes

**Kiểm tra pods có lỗi:**
```powershell
kubectl get pods
kubectl describe pod <pod-name>
kubectl logs <pod-name>
```

**Image pull error:**
```powershell
# Đảm bảo đã point Docker to Minikube
& minikube -p minikube docker-env --shell powershell | Invoke-Expression

# Rebuild images
docker build -t web-tu-thien-webapp:latest -f Dockerfile.webapp .
```

**Reset hoàn toàn:**
```powershell
kubectl delete -f k8s/
minikube delete
minikube start --driver=docker
```

## Kiến trúc Microservices

```
┌─────────────┐     ┌─────────────┐
│   Web App   │────▶│   REST API  │
│   :8080     │     │   :8081     │
└──────┬──────┘     └──────┬──────┘
       │                   │
       └───────┬───────────┘
               │
        ┌──────▼──────┐
        │    MySQL    │
        │    :3306    │
        └─────────────┘
```

## So sánh Docker Compose vs Kubernetes

| Feature | Docker Compose | Kubernetes |
|---------|----------------|------------|
| **Use Case** | Development local | Production, scaling |
| **Setup** | Đơn giản | Phức tạp hơn |
| **Scaling** | Manual | Auto-scaling |
| **Load Balancing** | Không | Có sẵn |
| **High Availability** | Không | Có |
| **Rolling Updates** | Không | Có |

## Tips

- ✅ Dùng `docker-compose` cho development (nhanh, đơn giản)
- ✅ Dùng `Kubernetes` cho production (scaling, HA, monitoring)
- ✅ Health checks đã được config sẵn
- ⚠️ Thay đổi database credentials trong production
- ✅ Sử dụng ConfigMaps và Secrets cho configuration management

## Workflow Development

### Development Flow (Docker Compose)
```
1. Sửa code
2. Save file
3. Chạy: docker-compose up --build
4. Test tại http://localhost:8080
5. Lặp lại
```

### Production Flow (Kubernetes)
```
1. Sửa code
2. Build image: docker build -t webapp:v2 -f Dockerfile.webapp .
3. Update deployment: kubectl set image deployment/webapp webapp=webapp:v2
4. Monitor: kubectl rollout status deployment/webapp
5. Rollback nếu lỗi: kubectl rollout undo deployment/webapp
```

## Các Lệnh Thường Dùng

### Docker Compose
```powershell
docker-compose up -d              # Start background
docker-compose logs -f webapp     # Xem logs webapp
docker-compose restart webapp     # Restart webapp
docker-compose ps                 # Xem status
docker-compose exec webapp sh     # SSH vào container
```

### Kubernetes
```powershell
kubectl get pods                  # List pods
kubectl logs -f <pod-name>        # Xem logs
kubectl exec -it <pod-name> -- sh # SSH vào pod
kubectl get svc                   # List services
kubectl scale deployment webapp --replicas=3  # Scale
```


